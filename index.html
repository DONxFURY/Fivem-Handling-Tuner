<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PROFESSIONAL | FiveM Handling.meta Tuner</title>

  <!-- Font Awesome for icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <!-- Chart.js for the radar chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- vkBeautify (optional, for pretty‐printing XML later if desired) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vkBeautify/0.99.00/vkbeautify.js"></script>

  <style>
    /* -------------------------------------------------------
       Color Variables, Typography, and Basic Reset
    ------------------------------------------------------- */
    :root {
      --bg-gradient: linear-gradient(
        135deg,
        #0f1a2f 0%,
        #1a2b4d 50%,
        #0f1a2f 100%
      );
      --panel-bg: rgba(25, 35, 60, 0.85);
      --panel-border: rgba(78, 205, 196, 0.25);
      --text-primary: #e0f7ff;
      --text-secondary: #a8c6e0;
      --accent-primary: #4ecdc4;
      --accent-secondary: #38b2a6;
      --danger: #ff5e7d;
      --success: #4ade80;
      --warning: #fbbf24;
      --chart-grid: rgba(78, 205, 196, 0.1);
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell",
        "Fira Sans", "Droid Sans", sans-serif;
    }

    body {
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
      position: relative;
    }

    /* Light SVG grid overlay in the background */
    body::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='200' height='200' viewBox='0 0 200 200'><rect width='200' height='200' fill='none'/><path d='M0,0 L200,200 M200,0 L0,200' stroke='rgba(78, 205, 196, 0.03)' stroke-width='1'/></svg>");
      opacity: 0.4;
      z-index: -1;
    }

    /* -------------------------------------------------------
       App Header Styles
    ------------------------------------------------------- */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--panel-border);
      position: relative;
    }

    .app-header::after {
      content: "";
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-primary), transparent);
    }

    .app-title {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .app-title h1 {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(to right, #4ecdc4, #38b2a6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 15px rgba(78, 205, 196, 0.2);
    }

    .app-title i {
      font-size: 2.2rem;
      color: var(--accent-primary);
      background: rgba(25, 35, 60, 0.7);
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(78, 205, 196, 0.2);
    }

    .app-controls {
      display: flex;
      gap: 15px;
    }

    /* -------------------------------------------------------
       Layout: Two-Column Grid for Content
    ------------------------------------------------------- */
    .app-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto 1fr auto;
      gap: 20px;
      height: calc(100vh - 160px);
    }

    /* -------------------------------------------------------
       Panel (card) Styles
    ------------------------------------------------------- */
    .panel {
      background: var(--panel-bg);
      backdrop-filter: blur(10px);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 25px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .panel:hover {
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4),
        0 0 0 1px rgba(78, 205, 196, 0.3);
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--panel-border);
    }

    .panel-header h2 {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--accent-primary);
    }

    .panel-header i {
      font-size: 1.3rem;
    }

    .panel-actions {
      display: flex;
      gap: 10px;
    }

    /* -------------------------------------------------------
       Button Styles (including ripple effect)
    ------------------------------------------------------- */
    .btn {
      background: var(--glass-bg);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      backdrop-filter: blur(5px);
      position: relative;
      overflow: hidden;
    }

    .btn:hover {
      background: rgba(78, 205, 196, 0.2);
      border-color: var(--accent-primary);
      transform: translateY(-2px);
    }

    .btn.btn-primary {
      background: linear-gradient(to right, #4ecdc4, #38b2a6);
      color: #0f1a2f;
      border: none;
      font-weight: 600;
    }

    .btn.btn-primary:hover {
      background: linear-gradient(to right, #38b2a6, #4ecdc4);
      box-shadow: 0 0 15px rgba(78, 205, 196, 0.4);
    }

    .btn.btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn.btn-warning {
      background: var(--warning);
      color: #0f1a2f;
    }

    /* -------------------------------------------------------
       Form Grid for Inputs
    ------------------------------------------------------- */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
      overflow-y: auto;
      padding-right: 10px;
      flex: 1;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 0.9rem;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group label i {
      color: var(--accent-secondary);
      font-size: 0.9rem;
    }

    .form-group input {
      padding: 12px;
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      background: rgba(10, 20, 40, 0.4);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
    }

    .form-group input:hover {
      background: rgba(15, 30, 60, 0.5);
    }

    /* -------------------------------------------------------
       XML Preview Box
    ------------------------------------------------------- */
    .output {
      background: rgba(10, 20, 40, 0.4);
      padding: 20px;
      border-radius: 8px;
      font-family: "Fira Code", monospace;
      font-size: 0.9rem;
      flex: 1;
      overflow-y: auto;
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
      white-space: pre-wrap;
      line-height: 1.6;
    }

    /* -------------------------------------------------------
       Chart Container
    ------------------------------------------------------- */
    .chart-container {
      height: 300px;
      width: 100%;
      position: relative;
    }

    /* -------------------------------------------------------
       Stats Grid (3 cards)
    ------------------------------------------------------- */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-top: 20px;
    }

    .stat-card {
      background: rgba(10, 20, 40, 0.4);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      border-color: var(--accent-primary);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-primary);
      margin: 10px 0;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      text-align: center;
    }

    /* -------------------------------------------------------
       Full-Width Panels
    ------------------------------------------------------- */
    .panel-full {
      grid-column: 1 / -1;
    }

    .panel-tall {
      grid-row: span 2;
    }

    /* -------------------------------------------------------
       Tab Buttons
    ------------------------------------------------------- */
    .panel-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    .tab {
      padding: 8px 20px;
      background: var(--glass-bg);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .tab.active {
      background: rgba(78, 205, 196, 0.2);
      color: var(--accent-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* -------------------------------------------------------
       File Input (Hidden)
    ------------------------------------------------------- */
    .file-input {
      display: none;
    }

    /* -------------------------------------------------------
       Status Bar at Bottom
    ------------------------------------------------------- */
    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(10, 20, 40, 0.6);
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid var(--glass-border);
      font-size: 0.9rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--success);
    }

    .status-indicator.warning {
      background: var(--warning);
    }

    .status-indicator.danger {
      background: var(--danger);
    }

    /* -------------------------------------------------------
       Scrollbar Styling
    ------------------------------------------------------- */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.1);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(78, 205, 196, 0.4);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(78, 205, 196, 0.6);
    }

    /* -------------------------------------------------------
       Responsive Adjustments
    ------------------------------------------------------- */
    @media (max-width: 1200px) {
      .app-content {
        grid-template-columns: 1fr;
      }

      .panel-tall {
        grid-row: auto;
      }
    }

    /* -------------------------------------------------------
       Modals (History, Settings, Compare, Simulator)
    ------------------------------------------------------- */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 20000;
    }

    .modal-content {
      background: var(--panel-bg);
      border: 1px solid var(--panel-border);
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 80%;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      position: relative;
    }

    .modal-content h3 {
      font-size: 1.3rem;
      color: var(--accent-primary);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .modal-content pre,
    .modal-content textarea {
      width: 100%;
      height: 300px;
      background: rgba(10, 20, 40, 0.4);
      color: var(--text-secondary);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: 10px;
      font-family: "Fira Code", monospace;
      font-size: 0.85rem;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    .modal-content ul {
      list-style: none;
      padding-left: 0;
      max-height: 300px;
      overflow-y: auto;
    }

    .modal-content ul li {
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--panel-border);
      padding-bottom: 6px;
    }

    .modal-content ul li span {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .modal-close {
      position: absolute;
      top: 15px;
      right: 20px;
      background: none;
      border: none;
      font-size: 1.2rem;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .modal-close:hover {
      color: var(--danger);
    }

    /* -------------------------------------------------------
       Simulator Canvas & Controls
    ------------------------------------------------------- */
    #simulatorCanvas {
      background: #0f1a2f;
      border: 1px solid var(--glass-border);
      display: block;
      margin: 0 auto 15px auto;
    }

    .sim-controls {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 15px;
    }

    .sim-status {
      color: var(--text-secondary);
      text-align: center;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- ───────────── APP HEADER ───────────── -->
  <div class="app-header">
    <div class="app-title">
      <i class="fas fa-car-crash"></i>
      <h1>FiveM Handling.meta Tuner</h1>
    </div>
    <div class="app-controls">
      <button class="btn" id="historyBtn"><i class="fas fa-history"></i> History</button>
      <button class="btn btn-danger" id="clearBtn"><i class="fas fa-trash-alt"></i> Clear</button>
      <button class="btn" id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
    </div>
  </div>

  <!-- ───────────── MAIN CONTENT GRID ───────────── -->
  <div class="app-content">
    <!-- ───────────── LEFT COLUMN: Handling Parameters ───────────── -->
    <div class="panel panel-tall">
      <div class="panel-header">
        <h2><i class="fas fa-sliders-h"></i> Handling Parameters</h2>
        <div class="panel-actions">
          <button class="btn" id="resetSectionBtn"><i class="fas fa-sync-alt"></i> Reset Section</button>
          <button class="btn"><i class="fas fa-question-circle"></i></button>
        </div>
      </div>

      <!-- ── Tabs for Parameter Sections ── -->
      <div class="panel-tabs">
        <div class="tab active" data-tab="core">Core Parameters</div>
        <div class="tab" data-tab="physics">Advanced Physics</div>
        <div class="tab" data-tab="suspension">Suspension</div>
        <div class="tab" data-tab="damage">Damage</div>
        <div class="tab" data-tab="subhandling">Sub Handling</div>
      </div>

      <!-- ─────────────────────────────────────────────────────────────────────────────────────
           CORE PARAMETERS TAB
      ───────────────────────────────────────────────────────────────────────────────────── -->
      <div id="core" class="tab-content active">
        <div class="form-grid">
          <!-- Handling Name -->
          <div class="form-group">
            <label><i class="fas fa-tag"></i> Handling Name</label>
            <input type="text" id="handlingName_value" value="404330i" />
          </div>

          <!-- Mass -->
          <div class="form-group">
            <label><i class="fas fa-weight-hanging"></i> Mass (kg)</label>
            <input
              type="number"
              id="fMass_value"
              value="1800.0"
              min="100"
              max="50000"
              step="1"
            />
          </div>

          <!-- Downforce Modifier (lowercase in XML) -->
          <div class="form-group">
            <label><i class="fas fa-wind"></i> Downforce Modifier</label>
            <input
              type="number"
              id="fdownforcemodifier_value"
              value="1000.0"
              min="0"
              max="5000"
              step="0.1"
            />
          </div>

          <!-- Initial Drag -->
          <div class="form-group">
            <label><i class="fas fa-tachometer-alt"></i> Initial Drag Coeff</label>
            <input
              type="number"
              id="initialDrag_value"
              value="7.5"
              min="0"
              max="10"
              step="0.1"
            />
          </div>

          <!-- Percent Submerged -->
          <div class="form-group">
            <label><i class="fas fa-water"></i> Percent Submerged</label>
            <input
              type="number"
              id="fPercentSubmerged_value"
              value="85.0"
              min="0"
              max="100"
              step="0.1"
            />
          </div>

          <!-- Centre of Mass -->
          <div class="form-group">
            <label><i class="fas fa-box"></i> Centre of Mass (x y z)</label>
            <input
              type="text"
              id="vecCentreOfMassOffset_value"
              value="0.0 0.2 0.0"
            />
          </div>

          <!-- Inertia Multiplier -->
          <div class="form-group">
            <label><i class="fas fa-cogs"></i> Inertia Multiplier (x y z)</label>
            <input
              type="text"
              id="vecInertiaMultiplier_value"
              value="1.2 1.3 1.8"
            />
          </div>

          <!-- Drive Bias Front -->
          <div class="form-group">
            <label><i class="fas fa-car"></i> Drive Bias Front</label>
            <input
              type="number"
              id="fDriveBiasFront_value"
              value="0.3"
              min="0"
              max="1"
              step="0.01"
            />
          </div>

          <!-- Initial Drive Gears -->
          <div class="form-group">
            <label><i class="fas fa-cogs"></i> Initial Drive Gears</label>
            <input
              type="number"
              id="nInitialDriveGears_value"
              value="9"
              min="1"
              max="12"
              step="1"
            />
          </div>

          <!-- Initial Drive Force -->
          <div class="form-group">
            <label><i class="fas fa-tachometer-alt"></i> Initial Drive Force</label>
            <input
              type="number"
              id="fInitialDriveForce_value"
              value="0.6"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- Drive Inertia -->
          <div class="form-group">
            <label><i class="fas fa-cogs"></i> Drive Inertia</label>
            <input
              type="number"
              id="fDriveInertia_value"
              value="1.0"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- Clutch Change Scale Up Shift -->
          <div class="form-group">
            <label><i class="fas fa-fire"></i> Clutch Change Scale (Up)</label>
            <input
              type="number"
              id="fClutchChangeRateScaleUpShift_value"
              value="2.3"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- Clutch Change Scale Down Shift -->
          <div class="form-group">
            <label><i class="fas fa-fire"></i> Clutch Change Scale (Down)</label>
            <input
              type="number"
              id="fClutchChangeRateScaleDownShift_value"
              value="2.3"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- Initial Drive Max Flat Vel -->
          <div class="form-group">
            <label><i class="fas fa-speedometer"></i> Initial Drive Max Flat Vel</label>
            <input
              type="number"
              id="fInitialDriveMaxFlatVel_value"
              value="328.0"
              min="0"
              max="500"
              step="0.1"
            />
          </div>

          <!-- Brake Force -->
          <div class="form-group">
            <label><i class="fas fa-tachometer-alt"></i> Brake Force</label>
            <input
              type="number"
              id="fBrakeForce_value"
              value="40.9"
              min="0"
              max="100"
              step="0.1"
            />
          </div>

          <!-- Brake Bias Front -->
          <div class="form-group">
            <label><i class="fas fa-balance-scale"></i> Brake Bias Front</label>
            <input
              type="number"
              id="fBrakeBiasFront_value"
              value="0.425"
              min="0"
              max="1"
              step="0.001"
            />
          </div>

          <!-- Hand Brake Force -->
          <div class="form-group">
            <label><i class="fas fa-hand-back-hand"></i> Hand Brake Force</label>
            <input
              type="number"
              id="fHandBrakeForce_value"
              value="0.6"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- Steering Lock -->
          <div class="form-group">
            <label><i class="fas fa-steering-wheel"></i> Steering Lock</label>
            <input
              type="number"
              id="fSteeringLock_value"
              value="45.0"
              min="0"
              max="50"
              step="0.5"
            />
          </div>

          <!-- Traction Curve Max -->
          <div class="form-group">
            <label><i class="fas fa-grip-lines"></i> Traction Curve Max</label>
            <input
              type="number"
              id="fTractionCurveMax_value"
              value="12.0"
              min="0"
              max="20"
              step="0.1"
            />
          </div>

          <!-- Traction Curve Min -->
          <div class="form-group">
            <label><i class="fas fa-grip-lines"></i> Traction Curve Min</label>
            <input
              type="number"
              id="fTractionCurveMin_value"
              value="11.0"
              min="0"
              max="20"
              step="0.1"
            />
          </div>

          <!-- Traction Curve Lateral -->
          <div class="form-group">
            <label><i class="fas fa-car-grip"></i> Traction Curve Lateral</label>
            <input
              type="number"
              id="fTractionCurveLateral_value"
              value="25.0"
              min="0"
              max="100"
              step="0.1"
            />
          </div>

          <!-- Traction Spring Delta Max -->
          <div class="form-group">
            <label><i class="fas fa-spring"></i> Traction Spring Delta Max</label>
            <input
              type="number"
              id="fTractionSpringDeltaMax_value"
              value="0.150000"
              min="0"
              max="1"
              step="0.001"
            />
          </div>

          <!-- Low Speed Traction Loss Mult -->
          <div class="form-group">
            <label><i class="fas fa-snail"></i> Low Speed Traction Loss Mult</label>
            <input
              type="number"
              id="fLowSpeedTractionLossMult_value"
              value="1.0"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- Camber Stiffnesss -->
          <div class="form-group">
            <label><i class="fas fa-cog"></i> Camber Stiffnesss</label>
            <input
              type="number"
              id="fCamberStiffnesss_value"
              value="0.0"
              min="0"
              max="10"
              step="0.01"
            />
          </div>

          <!-- Traction Bias Front -->
          <div class="form-group">
            <label><i class="fas fa-grip-lines"></i> Traction Bias Front</label>
            <input
              type="number"
              id="fTractionBiasFront_value"
              value="0.425"
              min="0"
              max="1"
              step="0.001"
            />
          </div>

          <!-- Traction Loss Mult -->
          <div class="form-group">
            <label><i class="fas fa-road"></i> Traction Loss Mult</label>
            <input
              type="number"
              id="fTractionLossMult_value"
              value="1.0"
              min="0"
              max="5"
              step="0.01"
            />
          </div>

          <!-- AI Handling (editable) -->
          <div class="form-group">
            <label><i class="fas fa-robot"></i> AIHandling</label>
            <input
              type="text"
              id="AIHandling_value"
              value="SPORTS_CAR"
            />
          </div>

        </div>
      </div>

      <!-- ─────────────────────────────────────────────────────────────────────────────────────
           ADVANCED PHYSICS TAB
      ───────────────────────────────────────────────────────────────────────────────────── -->
      <div id="physics" class="tab-content">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-bolt"></i> Engine Inertia</label>
            <input
              type="number"
              id="fEngineInertia_value"
              value="0.3"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-fire"></i> Clutch Change Scale (Up)</label>
            <input
              type="number"
              id="fClutchChangeRateScaleUpShift_value"
              value="2.3"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-fire"></i> Clutch Change Scale (Down)</label>
            <input
              type="number"
              id="fClutchChangeRateScaleDownShift_value"
              value="2.3"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-spring"></i> Suspension Force</label>
            <input
              type="number"
              id="fSuspensionForce_value"
              value="2.0"
              min="0"
              max="10"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-compress-arrows-alt"></i> Anti-Roll Bar Force</label>
            <input
              type="number"
              id="fAntiRollBarForce_value"
              value="0.4"
              min="0"
              max="2"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-compress"></i> Roll Centre Height Front</label>
            <input
              type="number"
              id="fRollCentreHeightFront_value"
              value="0.1"
              min="-1"
              max="1"
              step="0.01"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-tint"></i> Oil Volume</label>
            <input
              type="number"
              id="fOilVolume_value"
              value="5.0"
              min="0"
              max="20"
              step="0.5"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-tire"></i> Tire Grip</label>
            <input
              type="number"
              id="fTireGrip_value"
              value="0.48"
              min="0"
              max="1"
              step="0.01"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-tachometer-alt"></i> Brake Force</label>
            <input
              type="number"
              id="fBrakeForce_value"
              value="40.9"
              min="0"
              max="100"
              step="0.1"
            />
          </div>
        </div>
      </div>

      <!-- ─────────────────────────────────────────────────────────────────────────────────────
           SUSPENSION TAB
      ───────────────────────────────────────────────────────────────────────────────────── -->
      <div id="suspension" class="tab-content">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-compress"></i> Suspension Compression</label>
            <input
              type="number"
              id="fSuspensionCompDamp_value"
              value="0.8"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-expand"></i> Suspension Rebound</label>
            <input
              type="number"
              id="fSuspensionReboundDamp_value"
              value="1.6"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-arrow-up"></i> Suspension Upper Limit</label>
            <input
              type="number"
              id="fSuspensionUpperLimit_value"
              value="0.1"
              min="-1"
              max="1"
              step="0.01"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-arrow-down"></i> Suspension Lower Limit</label>
            <input
              type="number"
              id="fSuspensionLowerLimit_value"
              value="-0.1"
              min="-1"
              max="1"
              step="0.01"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-level-up-alt"></i> Suspension Raise</label>
            <input
              type="number"
              id="fSuspensionRaise_value"
              value="0.0"
              min="-1"
              max="1"
              step="0.01"
            />
          </div>
        </div>
      </div>

      <!-- ─────────────────────────────────────────────────────────────────────────────────────
           DAMAGE TAB
      ───────────────────────────────────────────────────────────────────────────────────── -->
      <div id="damage" class="tab-content">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-crash"></i> Collision Damage Mult</label>
            <input
              type="number"
              id="fCollisionDamageMult_value"
              value="0.7"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-gun"></i> Weapon Damage Mult</label>
            <input
              type="number"
              id="fWeaponDamageMult_value"
              value="1.0"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-car-burst"></i> Deformation Damage Mult</label>
            <input
              type="number"
              id="fDeformationDamageMult_value"
              value="0.7"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-engine"></i> Engine Damage Mult</label>
            <input
              type="number"
              id="fEngineDamageMult_value"
              value="1.5"
              min="0"
              max="5"
              step="0.1"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-gas-pump"></i> Petrol Tank Volume</label>
            <input
              type="number"
              id="fPetrolTankVolume_value"
              value="65.0"
              min="0"
              max="200"
              step="1"
            />
          </div>
        </div>
      </div>

      <!-- ─────────────────────────────────────────────────────────────────────────────────────
           SUB HANDLING TAB
      ───────────────────────────────────────────────────────────────────────────────────── -->
      <div id="subhandling" class="tab-content">
        <div class="form-grid">
          <div class="form-group">
            <label><i class="fas fa-car-crash"></i> fBackEndPopUpCarImpulseMult</label>
            <input
              type="number"
              id="fBackEndPopUpCarImpulseMult_value"
              value="0.1"
              min="0"
              max="5"
              step="0.001"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-building"></i> fBackEndPopUpBuildingImpulseMult</label>
            <input
              type="number"
              id="fBackEndPopUpBuildingImpulseMult_value"
              value="0.03"
              min="0"
              max="5"
              step="0.001"
            />
          </div>

          <div class="form-group">
            <label><i class="fas fa-tachometer-alt"></i> fBackEndPopUpMaxDeltaSpeed</label>
            <input
              type="number"
              id="fBackEndPopUpMaxDeltaSpeed_value"
              value="0.6"
              min="0"
              max="5"
              step="0.001"
            />
          </div>
        </div>
      </div>
    </div>

    <!-- ───────────── RIGHT TOP: Performance Visualization ───────────── -->
    <div class="panel">
      <div class="panel-header">
        <h2><i class="fas fa-chart-line"></i> Performance Visualization</h2>
        <div class="panel-actions">
          <button class="btn" id="exportChartBtn"><i class="fas fa-download"></i> Export Chart</button>
        </div>
      </div>

      <!-- Radar Chart Canvas -->
      <div class="chart-container">
        <canvas id="performanceChart"></canvas>
      </div>

      <!-- Three Stat Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <i class="fas fa-tachometer-alt"></i>
          <div class="stat-value" id="topSpeed">0</div>
          <div class="stat-label">Top Speed (km/h)</div>
        </div>

        <div class="stat-card">
          <i class="fas fa-stopwatch"></i>
          <div class="stat-value" id="acceleration">0.0s</div>
          <div class="stat-label">0–100 km/h</div>
        </div>

        <div class="stat-card">
          <i class="fas fa-grip-lines"></i>
          <div class="stat-value" id="lateralGrip">0.00g</div>
          <div class="stat-label">Lateral Grip</div>
        </div>
      </div>
    </div>

    <!-- ───────────── RIGHT BOTTOM: XML Preview ───────────── -->
    <div class="panel">
      <div class="panel-header">
        <h2><i class="fas fa-file-code"></i> XML Preview</h2>
        <div class="panel-actions">
          <button class="btn" id="expandPreviewBtn"><i class="fas fa-expand"></i></button>
        </div>
      </div>
      <!-- This <pre> holds the raw XML; JavaScript will replace values inside it -->
      <pre class="output" id="preview">&lt;CHandlingDataMgr&gt;
  &lt;HandlingData&gt;
    &lt;Item type="CHandlingData"&gt;
      &lt;handlingName&gt;404330i&lt;/handlingName&gt;
      &lt;fMass value="1800.000000" /&gt;
      &lt;fdownforcemodifier value="1000.000000" /&gt;
      &lt;fInitialDragCoeff value="7.500000" /&gt;
      &lt;fPercentSubmerged value="85.000000" /&gt;
      &lt;vecCentreOfMassOffset x="0.000000" y="0.200000" z="0.000000" /&gt;
      &lt;vecInertiaMultiplier x="1.200000" y="1.300000" z="1.800000" /&gt;
      &lt;fDriveBiasFront value="0.300000" /&gt;
      &lt;nInitialDriveGears value="9" /&gt;
      &lt;fInitialDriveForce value="0.600000" /&gt;
      &lt;fDriveInertia value="1.000000" /&gt;
      &lt;fClutchChangeRateScaleUpShift value="2.300000" /&gt;
      &lt;fClutchChangeRateScaleDownShift value="2.300000" /&gt;
      &lt;fInitialDriveMaxFlatVel value="328.000000" /&gt;
      &lt;fBrakeForce value="40.900000" /&gt;
      &lt;fBrakeBiasFront value="0.425000" /&gt;
      &lt;fHandBrakeForce value="0.600000" /&gt;
      &lt;fSteeringLock value="45.000000" /&gt;
      &lt;fTractionCurveMax value="12.000000" /&gt;
      &lt;fTractionCurveMin value="11.000000" /&gt;
      &lt;fTractionCurveLateral value="25.000000" /&gt;
      &lt;fTractionSpringDeltaMax value="0.150000" /&gt;
      &lt;fLowSpeedTractionLossMult value="1.000000" /&gt;
      &lt;fCamberStiffnesss value="0.000000" /&gt;
      &lt;fTractionBiasFront value="0.425000" /&gt;
      &lt;fTractionLossMult value="1.000000" /&gt;
      &lt;fSuspensionForce value="2.000000" /&gt;
      &lt;fSuspensionCompDamp value="0.800000" /&gt;
      &lt;fSuspensionReboundDamp value="1.600000" /&gt;
      &lt;fSuspensionUpperLimit value="0.100000" /&gt;
      &lt;fSuspensionLowerLimit value="-0.100000" /&gt;
      &lt;fSuspensionRaise value="0.000000" /&gt;
      &lt;fAntiRollBarForce value="0.400000" /&gt;
      &lt;fRollCentreHeightFront value="0.100000" /&gt;
      &lt;fRollCentreHeightRear value="0.100000" /&gt;
      &lt;fCollisionDamageMult value="0.700000" /&gt;
      &lt;fWeaponDamageMult value="1.000000" /&gt;
      &lt;fDeformationDamageMult value="0.700000" /&gt;
      &lt;fEngineDamageMult value="1.500000" /&gt;
      &lt;fPetrolTankVolume value="65.000000" /&gt;
      &lt;fOilVolume value="5.000000" /&gt;
      &lt;fSeatOffsetDistX value="0.000000" /&gt;
      &lt;fSeatOffsetDistY value="0.000000" /&gt;
      &lt;fSeatOffsetDistZ value="0.000000" /&gt;
      &lt;nMonetaryValue value="1000000" /&gt;
      &lt;strModelFlags&gt;0&lt;/strModelFlags&gt;
      &lt;strHandlingFlags&gt;0&lt;/strHandlingFlags&gt;
      &lt;strDamageFlags&gt;0&lt;/strDamageFlags&gt;
      &lt;AIHandling&gt;SPORTS_CAR&lt;/AIHandling&gt;
      &lt;SubHandlingData&gt;
        &lt;Item type="CCarHandlingData"&gt;
          &lt;fBackEndPopUpCarImpulseMult value="0.100000" /&gt;
          &lt;fBackEndPopUpBuildingImpulseMult value="0.030000" /&gt;
          &lt;fBackEndPopUpMaxDeltaSpeed value="0.600000" /&gt;
        &lt;/Item&gt;
        &lt;Item type="NULL" /&gt;
        &lt;Item type="NULL" /&gt;
      &lt;/SubHandlingData&gt;
    &lt;/Item&gt;
  &lt;/HandlingData&gt;
&lt;/CHandlingDataMgr&gt;</pre>
    </div>

    <!-- ─────────────────────────────────────────────────────────────────────────────────────
         FULL WIDTH: Export & Actions
    ───────────────────────────────────────────────────────────────────────────────────── -->
    <div class="panel panel-full">
      <div class="panel-header">
        <h2><i class="fas fa-file-export"></i> Export & Actions</h2>
        <div class="panel-actions">
          <button class="btn btn-primary" id="uploadBtn"><i class="fas fa-cloud-upload-alt"></i> Upload to Discord</button>
        </div>
      </div>

      <div class="btn-group" style="display: flex; gap: 15px; justify-content: center; margin-top: 10px;">
        <button id="importBtn" class="btn btn-primary"><i class="fas fa-folder-open"></i> Import Meta</button>
        <button id="exportBtn" class="btn btn-primary"><i class="fas fa-file-export"></i> Export Meta</button>
        <button id="resetBtn" class="btn btn-warning"><i class="fas fa-redo"></i> Reset All</button>
        <button class="btn btn-primary" id="simulatorBtn"><i class="fas fa-vial"></i> Test in Simulator</button>
        <button class="btn btn-primary" id="compareBtn"><i class="fas fa-history"></i> Compare Versions</button>
      </div>

      <div class="stats-grid" style="margin-top: 20px;">
        <div class="stat-card">
          <i class="fas fa-file-code"></i>
          <div class="stat-value" id="paramCount">0</div>
          <div class="stat-label">Parameters Tuned</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-save"></i>
          <div class="stat-value" id="fileSize">0.0</div>
          <div class="stat-label">KB File Size</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-code-branch"></i>
          <div class="stat-value" id="versionCount">0</div>
          <div class="stat-label">Saved Versions</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ─────────────────────────────────────────────────────────────────────────────────────
       STATUS BAR AT BOTTOM
  ───────────────────────────────────────────────────────────────────────────────────── -->
  <div class="status-bar">
    <div class="status-item">
      <div class="status-indicator"></div>
      <span id="connectionStatus">Connected to Discord</span>
    </div>
    <div class="status-item">
      <i class="fas fa-sync-alt" id="autosaveIcon"></i>
      <span id="autosaveStatus">Auto-Save: Enabled</span>
    </div>
    <div class="status-item">
      <i class="fas fa-code"></i>
      <span>Handling.meta v2.3 | Schema 1.2.5</span>
    </div>
    <div class="status-item">
      <i class="fas fa-user"></i>
      <span>User: admin@fivem.com</span>
    </div>
  </div>

  <!-- Hidden file input for “Import Meta” -->
  <input
    type="file"
    id="fileInput"
    class="file-input"
    accept=".meta,.xml"
  />

  <!-- ─────────────────────────────────────────────────────────────────────────────────────
       HISTORY MODAL
  ───────────────────────────────────────────────────────────────────────────────────── -->
  <div id="historyModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" id="historyCloseBtn">&times;</button>
      <h3><i class="fas fa-history"></i> Version History</h3>
      <ul id="historyList">
        <!-- Populated dynamically -->
      </ul>
      <div style="margin-top: 10px;">
        <h4>Selected Snapshot:</h4>
        <textarea id="historySelectedXml" readonly></textarea>
      </div>
    </div>
  </div>

  <!-- ─────────────────────────────────────────────────────────────────────────────────────
       SETTINGS MODAL
  ───────────────────────────────────────────────────────────────────────────────────── -->
  <div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" id="settingsCloseBtn">&times;</button>
      <h3><i class="fas fa-cog"></i> Settings</h3>
      <div style="margin-top: 10px;">
        <label style="display: flex; align-items: center; gap: 8px;">
          <input type="checkbox" id="autoSaveToggle" checked />
          <span>Auto-Save Enabled</span>
        </label>
      </div>
    </div>
  </div>

  <!-- ─────────────────────────────────────────────────────────────────────────────────────
       COMPARE MODAL
  ───────────────────────────────────────────────────────────────────────────────────── -->
  <div id="compareModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" id="compareCloseBtn">&times;</button>
      <h3><i class="fas fa-code-branch"></i> Compare Versions</h3>
      <pre id="compareDiffArea"></pre>
    </div>
  </div>

  <!-- ─────────────────────────────────────────────────────────────────────────────────────
       SIMULATOR MODAL
  ───────────────────────────────────────────────────────────────────────────────────── -->
  <div id="simulatorModal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" id="simulatorCloseBtn">&times;</button>
      <h3><i class="fas fa-car"></i> Vehicle Simulator</h3>
      <canvas id="simulatorCanvas" width="760" height="300"></canvas>
      <div class="sim-controls">
        <button class="btn btn-primary" id="simStartBtn"><i class="fas fa-play"></i> Start</button>
        <button class="btn btn-warning" id="simResetBtn"><i class="fas fa-undo"></i> Reset</button>
      </div>
      <div class="sim-status" id="simStatus">Speed: 0 km/h &nbsp;&nbsp; Distance: 0.00 km</div>
    </div>
  </div>

  <script>
    // ────────────────────────────────────────────────────────────────────────────
    // Global State
    // ────────────────────────────────────────────────────────────────────────────
    let versionHistory = [];        // Array of { timestamp: Date, xml: string }
    let autoSaveEnabled = true;     // Toggled in Settings

    // ────────────────────────────────────────────────────────────────────────────
    // computeTopSpeed(): guaranteed to return a positive number for realistic defaults
    // Adjust the constants (1600, 12000, 1.5, etc.) to get your desired "real-world" speed.
    // ────────────────────────────────────────────────────────────────────────────
    function computeTopSpeed() {
      const driveForce = parseFloat(
        document.getElementById("fInitialDriveForce_value").value || "0"
      );
      const dragCoeff = parseFloat(
        document.getElementById("initialDrag_value").value || "0"
      );
      const mass = parseFloat(
        document.getElementById("fMass_value").value || "0"
      );

      // Example formula:
      //   base = (driveForce * 1600) / (dragCoeff + 0.1)
      //   massFactor = 12000 / (mass + 200)
      //   raw = (base + massFactor) * 1.5
      let topSpeed =
        (
          driveForce * 1600 / (dragCoeff + 0.1) +
          12000 / (mass + 200)
        ) * 1.5;

      // Clamp between 0 and 500
      topSpeed = Math.max(0, Math.min(topSpeed, 500));
      return topSpeed;
    }

    // ────────────────────────────────────────────────────────────────────────────
    // computeAccelerationTime(): time to go 0–100 km/h
    // Formula: (mass / (traction * 100)) + 2.5, clamped [2s, 15s]
    // ────────────────────────────────────────────────────────────────────────────
    function computeAccelerationTime() {
      const traction = parseFloat(
        document.getElementById("fTractionCurveMax_value").value || "0"
      );
      const mass = parseFloat(
        document.getElementById("fMass_value").value || "0"
      );
      let accel = traction > 0 ? mass / (traction * 100) + 2.5 : 15;
      return Math.max(2, Math.min(accel, 15));
    }

    // ────────────────────────────────────────────────────────────────────────────
    // Initialize the radar chart for performance visualization
    // ────────────────────────────────────────────────────────────────────────────
    const ctx = document
      .getElementById("performanceChart")
      .getContext("2d");
    const performanceChart = new Chart(ctx, {
      type: "radar",
      data: {
        labels: [
          "Acceleration",
          "Top Speed",
          "Braking",
          "Cornering",
          "Stability",
          "Off-Road",
        ],
        datasets: [
          {
            label: "Current Handling",
            data: [0, 0, 0, 0, 0, 0],
            fill: true,
            backgroundColor: "rgba(78, 205, 196, 0.2)",
            borderColor: "rgba(78, 205, 196, 1)",
            pointBackgroundColor: "rgba(78, 205, 196, 1)",
            pointBorderColor: "#fff",
            pointHoverBackgroundColor: "#fff",
            pointHoverBorderColor: "rgba(78, 205, 196, 1)",
          },
          {
            label: "Default Handling",
            data: [75, 85, 75, 80, 70, 30], // placeholder default curve
            fill: true,
            backgroundColor: "rgba(255, 94, 125, 0.2)",
            borderColor: "rgba(255, 94, 125, 1)",
            pointBackgroundColor: "rgba(255, 94, 125, 1)",
            pointBorderColor: "#fff",
            pointHoverBackgroundColor: "#fff",
            pointHoverBorderColor: "rgba(255, 94, 125, 1)",
          },
        ],
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          r: {
            angleLines: {
              color: "rgba(255, 255, 255, 0.1)",
            },
            grid: {
              color: "var(--chart-grid)",
            },
            pointLabels: {
              color: "var(--text-secondary)",
              font: {
                size: 11,
              },
            },
            ticks: {
              display: false,
              stepSize: 20,
            },
          },
        },
        plugins: {
          legend: {
            labels: {
              color: "var(--text-primary)",
            },
          },
        },
      },
    });

    // ────────────────────────────────────────────────────────────────────────────
    // Tab Switching Logic
    // ────────────────────────────────────────────────────────────────────────────
    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", function () {
        document.querySelectorAll(".tab").forEach((t) =>
          t.classList.remove("active")
        );
        document
          .querySelectorAll(".tab-content")
          .forEach((c) => c.classList.remove("active"));

        this.classList.add("active");
        const tabId = this.getAttribute("data-tab");
        document.getElementById(tabId).classList.add("active");
      });
    });

    // ────────────────────────────────────────────────────────────────────────────
    // Every input change should recalc stats, update chart, update XML, update param count
    // ────────────────────────────────────────────────────────────────────────────
    document.querySelectorAll("input").forEach((input) => {
      input.addEventListener("input", function () {
        updatePerformanceStats();
        updateChart();
        updateXMLPreview();
        updateParamCount();

        if (autoSaveEnabled) {
          saveVersion(); // push to history if it differs
        }

        // Brief visual highlight on changed field
        this.style.boxShadow = "0 0 0 2px rgba(78, 205, 196, 0.4)";
        setTimeout(() => {
          this.style.boxShadow = "";
        }, 800);
      });
    });

    // ────────────────────────────────────────────────────────────────────────────
    // Button Event Listeners
    // ────────────────────────────────────────────────────────────────────────────
    document.getElementById("historyBtn").addEventListener("click", () => {
      openHistoryModal();
    });
    document.getElementById("historyCloseBtn").addEventListener("click", () => {
      closeHistoryModal();
    });

    document.getElementById("settingsBtn").addEventListener("click", () => {
      openSettingsModal();
    });
    document.getElementById("settingsCloseBtn").addEventListener("click", () => {
      closeSettingsModal();
    });

    document.getElementById("compareBtn").addEventListener("click", () => {
      openCompareModal();
    });
    document.getElementById("compareCloseBtn").addEventListener("click", () => {
      closeCompareModal();
    });

    document.getElementById("clearBtn").addEventListener("click", () => {
      clearAllFields();
    });

    document
      .getElementById("importBtn")
      .addEventListener("click", () => {
        document.getElementById("fileInput").click();
      });

    document
      .getElementById("exportBtn")
      .addEventListener("click", () => {
        exportMetaFile();
      });

    document
      .getElementById("resetBtn")
      .addEventListener("click", () => {
        resetAllValues();
      });

    document
      .getElementById("resetSectionBtn")
      .addEventListener("click", () => {
        resetCurrentSection();
      });

    document
      .getElementById("uploadBtn")
      .addEventListener("click", () => {
        uploadToDiscord();
      });

    document
      .getElementById("simulatorBtn")
      .addEventListener("click", () => {
        openSimulatorModal();
      });

    document
      .getElementById("expandPreviewBtn")
      .addEventListener("click", () => {
        expandPreview();
      });

    document
      .getElementById("exportChartBtn")
      .addEventListener("click", () => {
        exportChartImage();
      });

    // ────────────────────────────────────────────────────────────────────────────
    // Handle file selection (Import)
    // ────────────────────────────────────────────────────────────────────────────
    document
      .getElementById("fileInput")
      .addEventListener("change", function (e) {
        if (this.files && this.files[0]) {
          const fileName = this.files[0].name;
          document.getElementById(
            "connectionStatus"
          ).innerHTML = `Loaded: ${fileName}`;
          showNotification(`Successfully imported ${fileName}`, "success");
        }
      });

    // ────────────────────────────────────────────────────────────────────────────
    // On page load, initialize everything
    // ────────────────────────────────────────────────────────────────────────────
    updatePerformanceStats();
    updateChart();
    updateParamCount();

    // ────────────────────────────────────────────────────────────────────────────
    // FUNCTIONS
    // ────────────────────────────────────────────────────────────────────────────

    function updatePerformanceStats() {
      // Read relevant inputs
      const traction = parseFloat(
        document.getElementById("fTractionCurveMax_value").value || "0"
      );
      const suspension = parseFloat(
        document.getElementById("fSuspensionForce_value").value || "0"
      );

      // 1) Top Speed via computeTopSpeed()
      const topSpeed = computeTopSpeed();
      document.getElementById("topSpeed").textContent = Math.round(topSpeed);

      // 2) Acceleration (0–100 km/h):
      //    Example formula: (mass / (traction * 100)) + 2.5, clamped [2s, 15s]
      const mass = parseFloat(
        document.getElementById("fMass_value").value || "0"
      );
      let acceleration = traction > 0 ? mass / (traction * 100) + 2.5 : 15;
      acceleration = Math.max(2, Math.min(acceleration, 15));
      document.getElementById("acceleration").textContent =
        acceleration.toFixed(1) + "s";

      // 3) Lateral Grip:
      //    Example: 0.8 + (traction * 0.08) + (suspension * 0.02), clamped ≤ 1.5g
      let grip = 0.8 + traction * 0.08 + suspension * 0.02;
      grip = Math.min(grip, 1.5);
      document.getElementById("lateralGrip").textContent = grip.toFixed(2) + "g";
    }

    function updateChart() {
      // Read same inputs
      const mass = parseFloat(
        document.getElementById("fMass_value").value || "0"
      );
      const dragCoeff = parseFloat(
        document.getElementById("initialDrag_value").value || "0"
      );
      const driveForce = parseFloat(
        document.getElementById("fInitialDriveForce_value").value || "0"
      );
      const traction = parseFloat(
        document.getElementById("fTractionCurveMax_value").value || "0"
      );
      const suspension = parseFloat(
        document.getElementById("fSuspensionForce_value").value || "0"
      );
      const brakeForce = parseFloat(
        document.getElementById("fBrakeForce_value").value || "0"
      );

      // 1) Top Speed (same as computeTopSpeed)
      const topSpeed = computeTopSpeed();

      // 2) Acceleration time (same as updatePerformanceStats)
      let acceleration = traction > 0 ? mass / (traction * 100) + 2.5 : 15;
      acceleration = Math.max(2, Math.min(acceleration, 15));

      // 3) Braking: (brakeForce × 2.5) + 20, clamped ≤ 100
      let braking = brakeForce * 2.5 + 20;
      braking = Math.min(braking, 100);

      // 4) Cornering: (traction × 0.5) + (suspension × 0.3), clamped ≤ 100
      let cornering = traction * 0.5 + suspension * 0.3;
      cornering = Math.min(cornering, 100);

      // 5) Stability: suspension × 20, clamped ≤ 100
      let stability = suspension * 20;
      stability = Math.min(stability, 100);

      // 6) Off-Road: (traction × 0.2) + (suspension × 0.5), clamped ≤ 100
      let offRoad = traction * 0.2 + suspension * 0.5;
      offRoad = Math.min(offRoad, 100);

      performanceChart.data.datasets[0].data = [
        acceleration,
        topSpeed,
        braking,
        cornering,
        stability,
        offRoad,
      ];
      performanceChart.update();
    }

    function updateParamCount() {
      let changedCount = 0;
      document.querySelectorAll("input").forEach((input) => {
        if (input.value !== input.defaultValue) {
          changedCount++;
        }
      });
      document.getElementById("paramCount").textContent = changedCount;
    }

    function updateXMLPreview() {
      const previewEl = document.getElementById("preview");
      let xmlText = previewEl.textContent;

      // 1) <handlingName>
      const handlingName = document.getElementById("handlingName_value").value || "";
      xmlText = xmlText.replace(
        /<handlingName>.*?<\/handlingName>/,
        `<handlingName>${handlingName}</handlingName>`
      );

      // 2) <fMass>
      const massValue = parseFloat(
        document.getElementById("fMass_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fMass value="[^"]+" \/>/,
        `<fMass value="${massValue}" />`
      );

      // 3) <fdownforcemodifier> (lowercase)
      const downforceValue = parseFloat(
        document.getElementById("fdownforcemodifier_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fdownforcemodifier value="[^"]+" \/>/,
        `<fdownforcemodifier value="${downforceValue}" />`
      );

      // 4) <fInitialDragCoeff>
      const dragVal = parseFloat(
        document.getElementById("initialDrag_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fInitialDragCoeff value="[^"]+" \/>/,
        `<fInitialDragCoeff value="${dragVal}" />`
      );

      // 5) <fPercentSubmerged>
      const submergedVal = parseFloat(
        document.getElementById("fPercentSubmerged_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fPercentSubmerged value="[^"]+" \/>/,
        `<fPercentSubmerged value="${submergedVal}" />`
      );

      // 6) <vecCentreOfMassOffset>
      const comArr = (
        document.getElementById("vecCentreOfMassOffset_value").value || ""
      )
        .trim()
        .split(" ");
      if (comArr.length === 3) {
        const [x, y, z] = comArr.map((v) =>
          isNaN(parseFloat(v)) ? "0.000000" : parseFloat(v).toFixed(6)
        );
        xmlText = xmlText.replace(
          /<vecCentreOfMassOffset x="[^"]+" y="[^"]+" z="[^"]+" \/>/,
          `<vecCentreOfMassOffset x="${x}" y="${y}" z="${z}" />`
        );
      }

      // 7) <vecInertiaMultiplier>
      const inertiaArr = (
        document.getElementById("vecInertiaMultiplier_value").value || ""
      )
        .trim()
        .split(" ");
      if (inertiaArr.length === 3) {
        const [ix, iy, iz] = inertiaArr.map((v) =>
          isNaN(parseFloat(v)) ? "0.000000" : parseFloat(v).toFixed(6)
        );
        xmlText = xmlText.replace(
          /<vecInertiaMultiplier x="[^"]+" y="[^"]+" z="[^"]+" \/>/,
          `<vecInertiaMultiplier x="${ix}" y="${iy}" z="${iz}" />`
        );
      }

      // 8) <fDriveBiasFront>
      const driveBias = parseFloat(
        document.getElementById("fDriveBiasFront_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fDriveBiasFront value="[^"]+" \/>/,
        `<fDriveBiasFront value="${driveBias}" />`
      );

      // 9) <nInitialDriveGears>
      const gears = parseInt(
        document.getElementById("nInitialDriveGears_value").value || "0"
      );
      xmlText = xmlText.replace(
        /<nInitialDriveGears value="[^"]+" \/>/,
        `<nInitialDriveGears value="${gears}" />`
      );

      // 10) <fInitialDriveForce>
      const driveF = parseFloat(
        document.getElementById("fInitialDriveForce_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fInitialDriveForce value="[^"]+" \/>/,
        `<fInitialDriveForce value="${driveF}" />`
      );

      // 11) <fDriveInertia>
      const driveI = parseFloat(
        document.getElementById("fDriveInertia_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fDriveInertia value="[^"]+" \/>/,
        `<fDriveInertia value="${driveI}" />`
      );

      // 12) <fClutchChangeRateScaleUpShift>
      const clutchUp = parseFloat(
        document.getElementById("fClutchChangeRateScaleUpShift_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fClutchChangeRateScaleUpShift value="[^"]+" \/>/,
        `<fClutchChangeRateScaleUpShift value="${clutchUp}" />`
      );

      // 13) <fClutchChangeRateScaleDownShift>
      const clutchDown = parseFloat(
        document.getElementById("fClutchChangeRateScaleDownShift_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fClutchChangeRateScaleDownShift value="[^"]+" \/>/,
        `<fClutchChangeRateScaleDownShift value="${clutchDown}" />`
      );

      // 14) <fInitialDriveMaxFlatVel>
      const maxVel = parseFloat(
        document.getElementById("fInitialDriveMaxFlatVel_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fInitialDriveMaxFlatVel value="[^"]+" \/>/,
        `<fInitialDriveMaxFlatVel value="${maxVel}" />`
      );

      // 15) <fBrakeForce>
      const brake = parseFloat(
        document.getElementById("fBrakeForce_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fBrakeForce value="[^"]+" \/>/,
        `<fBrakeForce value="${brake}" />`
      );

      // 16) <fBrakeBiasFront>
      const biasF = parseFloat(
        document.getElementById("fBrakeBiasFront_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fBrakeBiasFront value="[^"]+" \/>/,
        `<fBrakeBiasFront value="${biasF}" />`
      );

      // 17) <fHandBrakeForce>
      const handBr = parseFloat(
        document.getElementById("fHandBrakeForce_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fHandBrakeForce value="[^"]+" \/>/,
        `<fHandBrakeForce value="${handBr}" />`
      );

      // 18) <fSteeringLock>
      const steerL = parseFloat(
        document.getElementById("fSteeringLock_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSteeringLock value="[^"]+" \/>/,
        `<fSteeringLock value="${steerL}" />`
      );

      // 19) <fTractionCurveMax>
      const tMax = parseFloat(
        document.getElementById("fTractionCurveMax_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fTractionCurveMax value="[^"]+" \/>/,
        `<fTractionCurveMax value="${tMax}" />`
      );

      // 20) <fTractionCurveMin>
      const tMin = parseFloat(
        document.getElementById("fTractionCurveMin_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fTractionCurveMin value="[^"]+" \/>/,
        `<fTractionCurveMin value="${tMin}" />`
      );

      // 21) <fTractionCurveLateral>
      const tLat = parseFloat(
        document.getElementById("fTractionCurveLateral_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fTractionCurveLateral value="[^"]+" \/>/,
        `<fTractionCurveLateral value="${tLat}" />`
      );

      // 22) <fTractionSpringDeltaMax>
      const tSpring = parseFloat(
        document.getElementById("fTractionSpringDeltaMax_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fTractionSpringDeltaMax value="[^"]+" \/>/,
        `<fTractionSpringDeltaMax value="${tSpring}" />`
      );

      // 23) <fLowSpeedTractionLossMult>
      const lowT = parseFloat(
        document.getElementById("fLowSpeedTractionLossMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fLowSpeedTractionLossMult value="[^"]+" \/>/,
        `<fLowSpeedTractionLossMult value="${lowT}" />`
      );

      // 24) <fCamberStiffnesss>
      const camber = parseFloat(
        document.getElementById("fCamberStiffnesss_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fCamberStiffnesss value="[^"]+" \/>/,
        `<fCamberStiffnesss value="${camber}" />`
      );

      // 25) <fTractionBiasFront>
      const tBias = parseFloat(
        document.getElementById("fTractionBiasFront_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fTractionBiasFront value="[^"]+" \/>/,
        `<fTractionBiasFront value="${tBias}" />`
      );

      // 26) <fTractionLossMult>
      const tLoss = parseFloat(
        document.getElementById("fTractionLossMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fTractionLossMult value="[^"]+" \/>/,
        `<fTractionLossMult value="${tLoss}" />`
      );

      // 27) <fSuspensionForce>
      const sForce = parseFloat(
        document.getElementById("fSuspensionForce_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSuspensionForce value="[^"]+" \/>/,
        `<fSuspensionForce value="${sForce}" />`
      );

      // 28) <fSuspensionCompDamp>
      const sComp = parseFloat(
        document.getElementById("fSuspensionCompDamp_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSuspensionCompDamp value="[^"]+" \/>/,
        `<fSuspensionCompDamp value="${sComp}" />`
      );

      // 29) <fSuspensionReboundDamp>
      const sReb = parseFloat(
        document.getElementById("fSuspensionReboundDamp_value")?.value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSuspensionReboundDamp value="[^"]+" \/>/,
        `<fSuspensionReboundDamp value="${sReb}" />`
      );

      // 30) <fSuspensionUpperLimit>
      const sUp = parseFloat(
        document.getElementById("fSuspensionUpperLimit_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSuspensionUpperLimit value="[^"]+" \/>/,
        `<fSuspensionUpperLimit value="${sUp}" />`
      );

      // 31) <fSuspensionLowerLimit>
      const sLow = parseFloat(
        document.getElementById("fSuspensionLowerLimit_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSuspensionLowerLimit value="[^"]+" \/>/,
        `<fSuspensionLowerLimit value="${sLow}" />`
      );

      // 32) <fSuspensionRaise>
      const sRaise = parseFloat(
        document.getElementById("fSuspensionRaise_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fSuspensionRaise value="[^"]+" \/>/,
        `<fSuspensionRaise value="${sRaise}" />`
      );

      // 33) <fAntiRollBarForce>
      const aRB = parseFloat(
        document.getElementById("fAntiRollBarForce_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fAntiRollBarForce value="[^"]+" \/>/,
        `<fAntiRollBarForce value="${aRB}" />`
      );

      // 34) <fRollCentreHeightFront>
      const rcf = parseFloat(
        document.getElementById("fRollCentreHeightFront_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fRollCentreHeightFront value="[^"]+" \/>/,
        `<fRollCentreHeightFront value="${rcf}" />`
      );

      // 35) <fRollCentreHeightRear>
      const rcr = parseFloat(
        document.getElementById("fRollCentreHeightRear_value")?.value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fRollCentreHeightRear value="[^"]+" \/>/,
        `<fRollCentreHeightRear value="${rcr}" />`
      );

      // 36) <fCollisionDamageMult>
      const cdm = parseFloat(
        document.getElementById("fCollisionDamageMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fCollisionDamageMult value="[^"]+" \/>/,
        `<fCollisionDamageMult value="${cdm}" />`
      );

      // 37) <fWeaponDamageMult>
      const wdm = parseFloat(
        document.getElementById("fWeaponDamageMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fWeaponDamageMult value="[^"]+" \/>/,
        `<fWeaponDamageMult value="${wdm}" />`
      );

      // 38) <fDeformationDamageMult>
      const ddm = parseFloat(
        document.getElementById("fDeformationDamageMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fDeformationDamageMult value="[^"]+" \/>/,
        `<fDeformationDamageMult value="${ddm}" />`
      );

      // 39) <fEngineDamageMult>
      const edm = parseFloat(
        document.getElementById("fEngineDamageMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fEngineDamageMult value="[^"]+" \/>/,
        `<fEngineDamageMult value="${edm}" />`
      );

      // 40) <fPetrolTankVolume>
      const ptv = parseFloat(
        document.getElementById("fPetrolTankVolume_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fPetrolTankVolume value="[^"]+" \/>/,
        `<fPetrolTankVolume value="${ptv}" />`
      );

      // 41) <fOilVolume>
      const ov = parseFloat(
        document.getElementById("fOilVolume_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fOilVolume value="[^"]+" \/>/,
        `<fOilVolume value="${ov}" />`
      );

      // ────────── SUB HANDLING REPLACEMENTS ──────────

      // 42) <fBackEndPopUpCarImpulseMult>
      const bCar = parseFloat(
        document.getElementById("fBackEndPopUpCarImpulseMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fBackEndPopUpCarImpulseMult value="[^"]+" \/>/,
        `<fBackEndPopUpCarImpulseMult value="${bCar}" />`
      );

      // 43) <fBackEndPopUpBuildingImpulseMult>
      const bBld = parseFloat(
        document.getElementById("fBackEndPopUpBuildingImpulseMult_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fBackEndPopUpBuildingImpulseMult value="[^"]+" \/>/,
        `<fBackEndPopUpBuildingImpulseMult value="${bBld}" />`
      );

      // 44) <fBackEndPopUpMaxDeltaSpeed>
      const bMax = parseFloat(
        document.getElementById("fBackEndPopUpMaxDeltaSpeed_value").value || "0"
      ).toFixed(6);
      xmlText = xmlText.replace(
        /<fBackEndPopUpMaxDeltaSpeed value="[^"]+" \/>/,
        `<fBackEndPopUpMaxDeltaSpeed value="${bMax}" />`
      );

      // ────────── <AIHandling> Replacement ──────────
      const aiHandling = document.getElementById("AIHandling_value").value || "";
      xmlText = xmlText.replace(
        /<AIHandling>.*?<\/AIHandling>/,
        `<AIHandling>${aiHandling}</AIHandling>`
      );

      // ─────────────────────────────────────────────────────────────────────
      // Finally, write back into the <pre> block
      // ─────────────────────────────────────────────────────────────────────
      previewEl.textContent = xmlText;
    }

    function resetAllValues() {
      document.querySelectorAll("input").forEach((input) => {
        input.value = input.defaultValue;
      });
      updatePerformanceStats();
      updateChart();
      updateXMLPreview();
      updateParamCount();
      showNotification("All values reset to default", "success");
      if (autoSaveEnabled) saveVersion();
    }

    function resetCurrentSection() {
      const activeTab = document.querySelector(".tab.active");
      if (activeTab) {
        const tabId = activeTab.getAttribute("data-tab");
        document
          .querySelectorAll(`#${tabId} input`)
          .forEach((input) => {
            input.value = input.defaultValue;
          });
        updatePerformanceStats();
        updateChart();
        updateXMLPreview();
        updateParamCount();
        showNotification(`Reset ${activeTab.textContent} section`, "success");
        if (autoSaveEnabled) saveVersion();
      }
    }

    function clearAllFields() {
      // Clear every input to empty
      document.querySelectorAll("input").forEach((input) => {
        input.value = "";
      });
      updatePerformanceStats();
      updateChart();
      updateXMLPreview();
      updateParamCount();
      showNotification("All fields cleared", "warning");
      if (autoSaveEnabled) saveVersion();
    }

    function exportMetaFile() {
      const fileName = "handling.meta";
      const content = document.getElementById("preview").textContent;
      const blob = new Blob([content], { type: "text/xml" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Push into versionHistory on export
      versionHistory.push({
        timestamp: new Date(),
        xml: content,
      });
      updateVersionCount();
      showNotification(`Exported ${fileName} successfully`, "success");
    }

    function saveVersion() {
      // Called on input change (if autoSaveEnabled). Push only if different from last.
      const content = document.getElementById("preview").textContent;
      if (
        versionHistory.length === 0 ||
        versionHistory[versionHistory.length - 1].xml !== content
      ) {
        versionHistory.push({
          timestamp: new Date(),
          xml: content,
        });
        updateVersionCount();
      }
    }

    function updateVersionCount() {
      document.getElementById("versionCount").textContent = versionHistory.length;
    }

    // ────────────────────────────────────────────────────────────────────────────
    // “Export Chart” (image) now works:
    // ────────────────────────────────────────────────────────────────────────────
    function exportChartImage() {
      // Grab the underlying <canvas> of Chart.js
      const chartCanvas = document.getElementById("performanceChart");
      const imageURL = chartCanvas.toDataURL("image/png");

      // Create a temporary <a> to download
      const link = document.createElement("a");
      link.href = imageURL;
      link.download = "performance_chart.png";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ────────────────────────────────────────────────────────────────────────────
    // Upload to Discord via webhook
    // ────────────────────────────────────────────────────────────────────────────
    async function uploadToDiscord() {
      const webhookURL = "https://discord.com/api/webhooks/1378444335456194640/8bxTkr5Htoh6daiX2XOeEUY_S5sQlkJzhTd0qFrOjPha8Xkd-0GkIYi6bhGsKWEcFnwZ";
      const xmlContent = document.getElementById("preview").textContent;
      const xmlBlob = new Blob([xmlContent], { type: "text/xml" });

      const form = new FormData();
      form.append("file", xmlBlob, "handling.meta");

      const payload = {
        content: "📥 New handling.meta uploaded by tuner",
        username: "FiveM Tuner Bot"
      };
      form.append("payload_json", JSON.stringify(payload));

      try {
        const response = await fetch(webhookURL, {
          method: "POST",
          body: form
        });

        if (response.ok) {
          document.getElementById("connectionStatus").innerText =
            "Uploaded to Discord webhook successfully!";
          showNotification("Uploaded to Discord ✅", "success");
        } else {
          console.error("Discord webhook error:", response.status, await response.text());
          showNotification("Failed to upload to Discord ❌", "error");
        }
      } catch (err) {
        console.error("Fetch error:", err);
        showNotification("Upload to Discord failed ❌", "error");
      }
    }

    // ────────────────────────────────────────────────────────────────────────────
    // Helpers for Simulator Modal
    // ────────────────────────────────────────────────────────────────────────────
    let simRequestId = null;
    let simStartTime = null;
    let simPaused = true;
    let simSpeed = 0;        // km/h
    let simDistance = 0;     // km
    let simPrevTimestamp = null;

    function openSimulatorModal() {
      document.getElementById("simulatorCanvas").style.display = "block";
      document.getElementById("simulatorModal").style.display = "flex";
      resetSimulation();
    }

    function closeSimulatorModal() {
      document.getElementById("simulatorModal").style.display = "none";
      cancelAnimationFrame(simRequestId);
      simPaused = true;
    }

    function resetSimulation() {
      simPaused = true;
      simSpeed = 0;
      simDistance = 0;
      simStartTime = null;
      simPrevTimestamp = null;
      updateSimStatus();
      clearCanvas();
    }

    function updateSimStatus() {
      const statusEl = document.getElementById("simStatus");
      statusEl.textContent = `Speed: ${simSpeed.toFixed(1)} km/h   Distance: ${simDistance.toFixed(2)} km`;
    }

    function clearCanvas() {
      const canvas = document.getElementById("simulatorCanvas");
      const ctx = canvas.getContext("2d");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function drawCar(xPos) {
      const canvas = document.getElementById("simulatorCanvas");
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "#4ecdc4";
      ctx.strokeStyle = "#38b2a6";
      ctx.lineWidth = 2;
      // Car represented as a rectangle with wheels
      ctx.fillRect(xPos, canvas.height / 2 - 15, 60, 30);
      ctx.strokeRect(xPos, canvas.height / 2 - 15, 60, 30);
      // Wheels
      ctx.fillStyle = "#0f1a2f";
      ctx.fillRect(xPos + 8, canvas.height / 2 + 12, 12, 5);
      ctx.fillRect(xPos + 40, canvas.height / 2 + 12, 12, 5);
    }

    function simulateFrame(timestamp) {
      if (!simStartTime) {
        simStartTime = timestamp;
        simPrevTimestamp = timestamp;
      }
      const dt = (timestamp - simPrevTimestamp) / 1000; // seconds elapsed since last frame
      simPrevTimestamp = timestamp;

      // 1) Compute acceleration (km/h per second) based on 0–100 time
      const accelTime = computeAccelerationTime(); // seconds to reach 100 km/h
      const accelRate = 100 / accelTime; // km/h per second

      // 2) Update speed
      if (simSpeed < computeTopSpeed()) {
        simSpeed += accelRate * dt;
        if (simSpeed > computeTopSpeed()) simSpeed = computeTopSpeed();
      }

      // 3) Update distance (km): v (km/h) * dt (s) / 3600
      simDistance += (simSpeed * dt) / 3600;

      // 4) Draw on canvas
      clearCanvas();
      // Map distance to pixel position: assume 1 km = 100 px
      const distancePx = (simDistance * 100) % (document.getElementById("simulatorCanvas").width - 80);
      drawCar(distancePx);

      // 5) Update status text
      updateSimStatus();

      // 6) Continue loop
      if (!simPaused) {
        simRequestId = requestAnimationFrame(simulateFrame);
      }
    }

    // Button handlers inside Simulator Modal
    document.getElementById("simStartBtn").addEventListener("click", () => {
      if (simPaused) {
        simPaused = false;
        simPrevTimestamp = null;
        simRequestId = requestAnimationFrame(simulateFrame);
      }
    });

    document.getElementById("simResetBtn").addEventListener("click", () => {
      cancelAnimationFrame(simRequestId);
      resetSimulation();
    });

    document.getElementById("simulatorCloseBtn").addEventListener("click", () => {
      closeSimulatorModal();
    });

    // ────────────────────────────────────────────────────────────────────────────
    // HISTORY MODAL FUNCTIONS
    // ────────────────────────────────────────────────────────────────────────────
    function openHistoryModal() {
      populateHistoryList();
      document.getElementById("historyModal").style.display = "flex";
    }

    function closeHistoryModal() {
      document.getElementById("historyModal").style.display = "none";
      document.getElementById("historySelectedXml").value = "";
    }

    function populateHistoryList() {
      const listEl = document.getElementById("historyList");
      listEl.innerHTML = ""; // clear

      if (versionHistory.length === 0) {
        const li = document.createElement("li");
        li.textContent = "No versions saved yet.";
        listEl.appendChild(li);
        return;
      }

      versionHistory.forEach((entry, idx) => {
        const li = document.createElement("li");
        const timestamp = new Date(entry.timestamp);
        const tsString = timestamp.toLocaleString();
        const span = document.createElement("span");
        span.textContent = tsString;

        const btnView = document.createElement("button");
        btnView.textContent = "View";
        btnView.className = "btn btn-primary";
        btnView.style.fontSize = "0.8rem";
        btnView.style.padding = "4px 8px";
        btnView.addEventListener("click", () => {
          document.getElementById("historySelectedXml").value = entry.xml;
        });

        li.appendChild(span);
        li.appendChild(btnView);
        listEl.appendChild(li);
      });
    }

    // ────────────────────────────────────────────────────────────────────────────
    // SETTINGS MODAL FUNCTIONS
    // ────────────────────────────────────────────────────────────────────────────
    function openSettingsModal() {
      // Set toggle to current state
      document.getElementById("autoSaveToggle").checked = autoSaveEnabled;
      document.getElementById("settingsModal").style.display = "flex";
    }

    function closeSettingsModal() {
      document.getElementById("settingsModal").style.display = "none";
    }

    document.getElementById("autoSaveToggle").addEventListener("change", (e) => {
      autoSaveEnabled = e.target.checked;
      document.getElementById(
        "autosaveStatus"
      ).textContent = `Auto-Save: ${autoSaveEnabled ? "Enabled" : "Disabled"}`;
      showNotification(
        `Auto-Save ${autoSaveEnabled ? "Enabled" : "Disabled"}`,
        "info"
      );
    });

    // ────────────────────────────────────────────────────────────────────────────
    // COMPARE MODAL FUNCTIONS
    // ────────────────────────────────────────────────────────────────────────────
    function openCompareModal() {
      const diffArea = document.getElementById("compareDiffArea");
      diffArea.textContent = ""; // clear

      if (versionHistory.length < 2) {
        diffArea.textContent = "Not enough versions to compare (need at least 2).";
      } else {
        const lastIdx = versionHistory.length - 1;
        const older = versionHistory[lastIdx - 1].xml.split("\n");
        const newer = versionHistory[lastIdx].xml.split("\n");

        // Build a simple diff:
        //   If line is same → show normally,
        //   If different → prefix "< " for older, "> " for newer.
        let diffText = "";
        const maxLines = Math.max(older.length, newer.length);
        for (let i = 0; i < maxLines; i++) {
          const oldLine = older[i] || "";
          const newLine = newer[i] || "";
          if (oldLine === newLine) {
            diffText += "  " + oldLine + "\n";
          } else {
            diffText += "< " + (oldLine || "[no line]") + "\n";
            diffText += "> " + (newLine || "[no line]") + "\n";
          }
        }
        diffArea.textContent = diffText;
      }

      document.getElementById("compareModal").style.display = "flex";
    }

    function closeCompareModal() {
      document.getElementById("compareModal").style.display = "none";
      document.getElementById("compareDiffArea").textContent = "";
    }

    // ────────────────────────────────────────────────────────────────────────────
    // HELPERS
    // ────────────────────────────────────────────────────────────────────────────

    // Initial XML preview push into history if auto-save on load
    function initialSave() {
      saveVersion();
    }
    initialSave();

    function showNotification(message, type) {
      const notification = document.createElement("div");
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${
          type === "success"
            ? "check-circle"
            : type === "error"
            ? "exclamation-circle"
            : "info-circle"
        }"></i>
        ${message}
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.classList.add("show");
      }, 10);
      setTimeout(() => {
        notification.classList.remove("show");
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Notification CSS (appended dynamically)
    const notificationStyle = document.createElement("style");
    notificationStyle.innerHTML = `
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        background: var(--panel-bg);
        border: 1px solid var(--panel-border);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        transform: translateX(150%);
        transition: transform 0.3s ease-out;
        z-index: 10000;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        border-left: 4px solid var(--success);
      }

      .notification.info {
        border-left: 4px solid var(--accent-primary);
      }

      .notification.error {
        border-left: 4px solid var(--danger);
      }
    `;
    document.head.appendChild(notificationStyle);

    // Ripple effect on buttons
    document.querySelectorAll(".btn").forEach((button) => {
      button.addEventListener("click", function (e) {
        const ripple = document.createElement("span");
        ripple.classList.add("ripple");
        this.appendChild(ripple);

        const rect = this.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        ripple.style.width = ripple.style.height = `${size}px`;
        ripple.style.left = `${x}px`;
        ripple.style.top = `${y}px`;

        setTimeout(() => {
          ripple.remove();
        }, 600);
      });
    });

    const rippleCSS = document.createElement("style");
    rippleCSS.innerHTML = `
      .ripple {
        position: absolute;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: scale(0);
        animation: ripple 0.6s linear;
      }

      @keyframes ripple {
        to {
          transform: scale(4);
          opacity: 0;
        }
      }
    `;
    document.head.appendChild(rippleCSS);
  </script>
</body>
</html>
