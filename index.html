<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PROFESSIONAL | FiveM Handling.meta Tuner</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root { --bg: #1e1e2f; --panel-bg: #2a2a3f; --text: #e0e0e0; --accent: #4ecdc4; --accent-dark: #38b2a6; --border: #3a3a4a; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: 'Exo 2', sans-serif; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; font-size: 2.5rem; }
    .btn-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
    .btn { background: var(--accent); color: var(--bg); border: none; padding: 10px 20px; cursor: pointer; border-radius: 6px; transition: background 0.3s; }
    .btn:hover { background: var(--accent-dark); }
    .panel { background: var(--panel-bg); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 20px; }
    .panel h2 { margin-bottom: 10px; font-size: 1.5rem; display: flex; align-items: center; gap: 8px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { margin-bottom: 5px; font-size: 0.9rem; }
    .form-group input { padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: #3a3a4a; color: var(--text); }
    .output { background: #121224; padding: 15px; border-radius: 6px; font-family: monospace; max-height: 400px; overflow-y: auto; white-space: pre-wrap; }
  </style>
  <!-- Load vkbeautify before using it -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vkBeautify/0.99.00/vkbeautify.js"></script>
</head>
<body>
  <h1><i class="fas fa-tools"></i> Handling.meta Tuner</h1>
  <div class="btn-group">
    <button id="importBtn" class="btn"><i class="fas fa-folder-open"></i> Import Meta</button>
    <button id="exportBtn" class="btn"><i class="fas fa-file-export"></i> Export Meta</button>
    <button id="resetBtn" class="btn"><i class="fas fa-redo"></i> Reset</button>
  </div>
  <input type="file" id="fileInput" accept=".meta,.xml" style="display:none">

  <div id="controlsPanel" class="panel">
    <h2><i class="fas fa-sliders-h"></i> Parameters</h2>
    <div id="formGrid" class="form-grid"></div>
  </div>

  <div id="previewPanel" class="panel">
    <h2><i class="fas fa-file-code"></i> Full XML Preview</h2>
    <pre id="preview" class="output"></pre>
  </div>

  <script>
    const importBtn = document.getElementById('importBtn');
    const exportBtn = document.getElementById('exportBtn');
    const resetBtn = document.getElementById('resetBtn');
    const fileInput = document.getElementById('fileInput');
    const formGrid = document.getElementById('formGrid');
    const preview = document.getElementById('preview');

    let defaults = {};
    let xmlDoc = null;
    let itemEl = null;
    let originalXmlText = '';

    importBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', handleImport);
    exportBtn.addEventListener('click', handleExport);
    resetBtn.addEventListener('click', handleReset);

    function handleImport(e) {
      const file = e.target.files[0]; if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        originalXmlText = reader.result;
        xmlDoc = new DOMParser().parseFromString(originalXmlText, 'application/xml');
        itemEl = xmlDoc.querySelector('Item[type="CHandlingData"]');
        if (!itemEl) return alert('No <Item type="CHandlingData"> found');

        defaults = {};
        formGrid.innerHTML = '';

        [...itemEl.childNodes].forEach(node => {
          if (node.nodeType !== 1) return;
          const tag = node.tagName;
          if (tag === 'SubHandlingData') return;

          if (node.hasAttribute('value')) {
            const val = node.getAttribute('value');
            defaults[`${tag}_value`] = val;
            createInput(tag, 'value', val);
          } else if (node.children.length === 0 && node.textContent.trim()) {
            const val = node.textContent.trim();
            defaults[`${tag}_text`] = val;
            createInput(tag, 'text', val);
          } else if (node.attributes.length > 0) {
            [...node.attributes].forEach(attr => {
              const id = `${tag}_${attr.name}`;
              defaults[id] = attr.value;
              createInput(tag, attr.name, attr.value);
            });
          }
        });
        updatePreview();
      };
      reader.readAsText(file);
    }

    function createInput(tag, attr, val) {
      const id = `${tag}_${attr}`;
      const group = document.createElement('div'); group.className = 'form-group';
      const label = document.createElement('label');
      label.textContent = attr === 'text' ? tag : `${tag} ${attr}`;
      const input = document.createElement('input');
      input.id = id; input.value = val;
      input.dataset.tag = tag; input.dataset.attr = attr;
      input.addEventListener('input', () => {
        applyChange(tag, attr, input.value);
        updatePreview();
      });
      group.append(label, input);
      formGrid.appendChild(group);
    }

    function applyChange(tag, attr, value) {
      if (!itemEl) return;
      const target = itemEl.querySelector(tag);
      if (!target) return;
      if (attr === 'text') target.textContent = value;
      else target.setAttribute(attr, value);
    }

    function updatePreview() {
      if (!xmlDoc) return;
      const serializer = new XMLSerializer();
      const declaration = '<?xml version="1.0" encoding="UTF-8"?>\n';
      const body = serializer.serializeToString(xmlDoc.documentElement);
      const fullXml = declaration + body;
      preview.textContent = (typeof vkbeautify === 'object' && vkbeautify.xml)
        ? vkbeautify.xml(fullXml)
        : fullXml;
    }

    function handleExport() {
      const content = preview.textContent;
      const blob = new Blob([content], { type: 'text/xml' });
      const link = document.createElement('a'); link.href = URL.createObjectURL(blob);
      link.download = 'handling.meta'; link.click();
    }

    function handleReset() {
      Object.entries(defaults).forEach(([id, val]) => {
        const inp = document.getElementById(id);
        if (inp) {
          inp.value = val;
          applyChange(inp.dataset.tag, inp.dataset.attr, val);
        }
      });
      updatePreview();
    }
  </script>
</body>
</html>
